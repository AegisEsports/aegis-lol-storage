name: Changelog semantic versioning

on:
  pull_request:
    branches:
      - main
    paths:
      - CHANGELOG.md

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          # For pull_request events, head_ref is the source branch name
          ref: ${{ github.head_ref }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*' # always use current LTS
          cache: 'npm'
          check-latest: true

      - name: Lint CHANGELOG template structure
        run: |
          if ! grep -q "^# Template" CHANGELOG.md; then
            echo "CHANGELOG.md must start with '# Template'"
            exit 1
          fi

          for h in "Breaking Change" "Add" "Remove" "Fix"; do
            if ! grep -q "^## $h" CHANGELOG.md; then
              echo "Missing '## $h' section under Template"
              exit 1
            fi
          done

          # Extract just the Template block (everything before first "# x.y.z")
          TEMPLATE_BLOCK=$(awk '
            /^# [0-9]+\.[0-9]+\.[0-9]+/ {exit}
            {print}
          ' CHANGELOG.md)

          # Require at least one bullet in the Template when it changes
          if ! printf "%s\n" "$TEMPLATE_BLOCK" | grep -q "^- "; then
            echo "Template must contain at least one bullet ('- something') when CHANGELOG is modified."
            exit 1
          fi

      - name: Bump version + rewrite CHANGELOG + package files
        run: |
          node scripts/bump-version-from-changelog.mjs

      - name: Commit updated files back to PR
        run: |
          # If nothing changed, skip commit
          if git diff --quiet; then
            echo "No version-related changes detected; skipping commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md
          if [ -f package.json ]; then git add package.json; fi
          if [ -f package-lock.json ]; then git add package-lock.json; fi

          # Read version from package.json for commit message
          NEW_VERSION=$(node -p "require('./package.json').version")

          git commit -m "chore(release): v${NEW_VERSION}"
          git push origin HEAD:${{ github.head_ref }}
